<html>

<head>
    <style>
        .cell {
            display: inline-block;
            border: 1px solid #b0b0b0;
            background: #eee;
            width: 20px;
            height: 20px;
            margin: 1;
        }

        .cell.fig {
            background-color: #088;
        }

        .cell.fig.center {
            background-color: #aa0;
        }

        .cell.full {
            background-color: #080;
        }

        .cell.fig.ready-to-freeze {
            background-color: #464;
        }
    </style>
</head>

<body>
    <div style="display: flex;justify-content: center;">
        <div id="board">
        </div>
    </div>

    <script>
        const boardWidth = 10;
        const boardHeight = 20;

        let fx = 1;
        let fy = 1;


        let figures = [
            //O#O - fig 0
            // O
            [
                [{ "x": 0, "y": 0 }, { "x": -1, "y": 0 }, { "x": 1, "y": 0 }, { "x": 0, "y": 1 }],
                [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": -1, "y": 0 }, { "x": 0, "y": 1 }],
                [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": -1, "y": 0 }, { "x": 1, "y": 0 }],
                [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": 1, "y": 0 }, { "x": 0, "y": 1 }]
            ],
            //#O - fig 1
            //OO
            [
                [{ "x": 0, "y": 0 }, { "x": 1, "y": 0 }, { "x": 0, "y": 1 }, { "x": 1, "y": 1 }],
            ],
            //O# -fig 2
            // OO
            [[{ "x": 0, "y": 0 }, { "x": -1, "y": 0 }, { "x": 0, "y": 1 }, { "x": 1, "y": 1 }], [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": -1, "y": 0 }, { "x": -1, "y": 1 }]],
            // #O - fig 3
            //OO
            [[{ "x": 0, "y": 0 }, { "x": 1, "y": 0 }, { "x": -1, "y": 1 }, { "x": 0, "y": 1 }], [{ "x": 0, "y": 0 }, { "x": -1, "y": -1 }, { "x": -1, "y": 0 }, { "x": 0, "y": 1 }]],
            //O#O - fig 4
            //O
            [[{ "x": 0, "y": 0 }, { "x": -1, "y": 0 }, { "x": 1, "y": 0 }, { "x": -1, "y": 1 }], [{ "x": 0, "y": 0 }, { "x": -1, "y": -1 }, { "x": 0, "y": -1 }, { "x": 0, "y": 1 }], [{ "x": 0, "y": 0 }, { "x": 1, "y": -1 }, { "x": -1, "y": 0 }, { "x": 1, "y": 0 }], [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": 0, "y": 1 }, { "x": 1, "y": 1 }]],
            //O#O - fig 5
            //  O
            [[{ "x": 0, "y": 0 }, { "x": -1, "y": 0 }, { "x": 1, "y": 0 }, { "x": 1, "y": 1 }], [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": -1, "y": 1 }, { "x": 0, "y": 1 }], [{ "x": 0, "y": 0 }, { "x": -1, "y": -1 }, { "x": -1, "y": 0 }, { "x": 1, "y": 0 }], [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": 1, "y": -1 }, { "x": 0, "y": 1 }]],
            //O#OO - fig 6
            [[{ "x": 0, "y": 0 }, { "x": -1, "y": 0 }, { "x": 1, "y": 0 }, { "x": 2, "y": 0 }], [{ "x": 0, "y": 0 }, { "x": 0, "y": -1 }, { "x": 0, "y": 1 }, { "x": 0, "y": 2 }]],
        ];
        let figNum = 0;
        let figView = 0;
        let isReadyToFreeze = false;
        let board = [];


        const boardEl = document.getElementById('board');
        createBoard();
        nextFig();

        paintFig(fx, fy, figNum, figView);

        document.addEventListener('keyup', e => {
            isReadyToFreeze = false;
            eraseFig(fx, fy, figNum, figView);
            if (e.code === 'ArrowLeft' && canMove(fx - 1, fy, figNum, figView)) fx--;
            if (e.code === 'ArrowRight' && canMove(fx + 1, fy, figNum, figView)) fx++;
            if (e.code === 'ArrowDown' && canMove(fx, fy, figNum, incFigView(figNum, figView))) figView = incFigView(figNum, figView);
            if (e.code === 'ArrowUp' && canMove(fx, fy, figNum, decFigView(figNum, figView))) figView = decFigView(figNum, figView);
            if (e.code === 'Space') fallDown();

            paintFig(fx, fy, figNum, figView);
            console.log(e.code, fx, fy, figNum, figView);
        });

        let timer = setInterval(() => {
            if (canMove(fx, fy + 1, figNum, figView)) {
                eraseFig(fx, fy, figNum, figView);
                fy++;
                paintFig(fx, fy, figNum, figView);
            } else if (!isReadyToFreeze) {
                eraseFig(fx, fy, figNum, figView);
                isReadyToFreeze = true;
                paintFig(fx, fy, figNum, figView);
            } else {
                eraseFig(fx, fy, figNum, figView);
                freezeFig(fx, fy, figNum, figView);
                nextFig();
                if (!canMove(fx, fy, figNum, figView)) {
                    gameOver();
                } else {
                    paintFig(fx, fy, figNum, figView);
                }
            }
        }, 500)

        function fallDown() {
            while (canMove(fx, fy + 1, figNum, figView)) {
                eraseFig(fx, fy, figNum, figView);
                fy++;
                paintFig(fx, fy, figNum, figView);
            }

        }

        function nextFig() {
            fx = Math.floor(boardWidth / 2);
            fy = 0;
            figView = 0;
            figNum = Math.floor(Math.random() * figures.length);
            isReadyToFreeze = false;
        }

        function gameOver() {
            clearInterval(timer);
            boardEl.innerHTML = 'GAME OVER';
        }

        function incFigNum(num) {
            return (num + 1) % figures.length;
        }

        function incFigView(num, view) {
            return (view + 1) % figures[num].length;
        }

        function decFigView(num, view) {
            return view === 0 ? figures[num].length - 1 : view - 1;
        }

        function paintFig(x, y, num, view) {
            const fig = figures[num][view];
            for (let i = 0; i < fig.length; i++) {
                const nx = x + fig[i].x;
                const ny = y + fig[i].y;
                setClass(nx, ny, i === 0 ? 'fig center' : isReadyToFreeze ? 'fig ready-to-freeze' : 'fig');
            }
        }

        function eraseFig(x, y, num, view) {
            const fig = figures[num][view];
            for (let i = 0; i < fig.length; i++) {
                const nx = x + fig[i].x;
                const ny = y + fig[i].y;
                setClass(nx, ny, '');
            }
        }

        function freezeFig(x, y, num, view) {
            const fig = figures[num][view];
            for (let i = 0; i < fig.length; i++) {
                const nx = x + fig[i].x;
                const ny = y + fig[i].y;
                board[ny][nx] = 1;
                setClass(nx, ny, 'full');
            }
        }


        function canMove(x, y, num, view) {
            const fig = figures[num][view];

            for (let i = 0; i < fig.length; i++) {
                const nx = x + fig[i].x;
                const ny = y + fig[i].y;
                if (nx < 0 || nx >= boardWidth) return false;
                if (ny < 0 || ny >= boardHeight) return false;
                if (board[ny][nx] !== 0) return false;
            }
            return true;
        }

        function setClass(x, y, className) {
            boardEl.querySelectorAll('.cell')[y * boardWidth + x].className = 'cell ' + className;
        }

        function createBoard() {
            let s = '';
            board = [];
            for (let y = 0; y < boardHeight; y++) {
                board[y] = [];
                for (let x = 0; x < boardWidth; x++) {
                    board[y][x] = 0;
                    s += `<div class='cell'></div>`
                }
                s += "<br/>"
            }
            boardEl.innerHTML = s;
        }
    </script>
</body>

</html>